import htmlMinifier from "html-minifier"
import Stage from "./stage"

export default class MinifyHtmlStage extends Stage {
  constructor(parent, name, dependencies, htmlFactory) {
    super(parent, name, dependencies)
    this.htmlFactory = htmlFactory
  }

  performStart() {
    this.minified = this.htmlFactory()
    if (this.oneOff()) {
      this.minified = htmlMinifier.minify(this.minified, {
        caseSensitive: false,
        collapseBooleanAttributes: true,
        collapseInlineTagWhitespace: true,
        collapseWhitespace: true,
        conservativeCollapse: false,
        customAttrAssign: [],
        customAttrCollapse: null,
        customAttrSurround: [],
        customEventAttributes: [],
        decodeEntities: true,
        html5: true,
        ignoreCustomComments: [],
        ignoreCustomFragments: [],
        includeAutoGeneratedTags: false,
        keepClosingSlash: false,
        maxLineLength: null,
        minifyCSS: {
          level: {
            2: {
              all: true
            }
          }
        },
        minifyJS: false,
        minifyURLs: false,
        preserveLineBreaks: false,
        preventAttributesEscaping: false,
        processConditionalComments: false,
        processScripts: [],
        quoteCharacter: `"`,
        removeAttributeQuotes: true,
        removeComments: true,
        removeEmptyAttributes: true,
        removeEmptyElements: true,
        removeOptionalTags: true,
        removeRedundantAttributes: true,
        removeScriptTypeAttributes: true,
        removeStyleLinkTypeAttributes: true,
        removeTagWhitespace: true,
        sortAttributes: true,
        sortClassName: true,
        trimCustomFragments: true,
        useShortDoctype: true
      })
    }
    this.done()
  }
}
